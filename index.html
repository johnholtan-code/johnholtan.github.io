<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>The Hazmat Guys - Flaminator 9000</title>
<style>
  :root { --bg:#0b1220; --panel:#101826; --muted:#5f728a; --text:#e8eef8; --accent:#ff7b00; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial}
  header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid #1c2838;background:linear-gradient(180deg,#1a0e00,#0f0600)}
  header h1{margin:0;font-size:18px}
  header p{margin:4px 0 0;color:var(--muted)}
  .settings-btn{background:var(--accent);color:#fff;border:none;border-radius:8px;padding:6px 12px;cursor:pointer;font-weight:bold;}
  .wrap{display:grid;grid-template-columns:360px 1fr;gap:14px;padding:14px;min-height:calc(100vh - 70px)}
  .panel{background:var(--panel);border:1px solid #1b2738;border-radius:14px;padding:14px;transition:transform 0.3s ease,opacity 0.3s ease;}
  fieldset{border:1px solid #39210a;border-radius:12px;margin:10px 0;padding:10px}
  legend{padding:0 8px;color:#ffb74d}
  label{display:block;margin:8px 0 4px;color:#e6c59a}
  input[type="range"],select,button{width:100%}
  .hint{color:#b38c4c;font-size:12px}
  .stage{position:relative;display:grid;place-items:center;background:#000;border-radius:14px;border:1px solid #1b2738;min-height:60vh;overflow:hidden}
  canvas{max-width:100%;height:auto;border-radius:12px;background:#000}

  /* Settings Modal */
  #settingsModal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:999;}
  .modal-content{background:var(--panel);border:1px solid #444;border-radius:10px;padding:20px;min-width:300px;max-width:400px;}
  .modal-content h2{margin-top:0;color:#ffb74d;text-align:center;}
  .modal-content label{margin-top:10px;}
  .modal-content button{margin-top:14px;background:var(--accent);color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;width:100%;}

  /* === Collapsible sidebar (append-only) === */
  #panelToggle {
    position: fixed;
    top: 50%;
    left: 0;
    transform: translateY(-50%);
    background: var(--accent);
    color: #fff;
    border: none;
    border-radius: 0 6px 6px 0;
    font-size: 16px;
    width: 28px;
    height: 48px;
    cursor: pointer;
    z-index: 1001;
    box-shadow: 2px 0 5px rgba(0,0,0,0.4);
    transition: background 0.2s ease, transform 0.3s ease;
  }
  #panelToggle:hover { background: #ffb74d; }
  .wrap.is-collapsed aside.panel {
    transform: translateX(-360px);
    opacity: 0;
    pointer-events: none;
  }
  aside.panel { box-shadow: 6px 0 20px rgba(0,0,0,0.35); }
  .wrap.is-collapsed + #panelToggle { transform: translateY(-50%) rotate(180deg); }
</style>

<!-- ===== APPENDED THEME OVERRIDES (Black + Yellow) ‚Äî APPEND ONLY ===== -->
<style>
  /* Strong black/yellow palette without deleting original rules */
  :root {
    --bg:#000000;                 /* deep black */
    --panel:#0a0a0a;              /* near-black panel */
    --text:#f5f5f5;               /* readable light text on black */
    --muted:#c9b458;              /* paragraph yellow ‚Äî the reference color */
    --accent:#ffd400;             /* bright safety yellow */
  }

  header{
    border-bottom:1px solid rgba(255,212,0,0.25);
    background:linear-gradient(180deg,#0a0a0a,#000000);
  }
  .panel{
    border-color:rgba(255,212,0,0.15);
    box-shadow:0 0 0 1px rgba(255,212,0,0.05), 0 8px 24px rgba(0,0,0,0.6);
  }
  fieldset{
    border:1px solid rgba(255,212,0,0.25);
  }
  legend{
    color:#ffd400;
    font-weight:600;
    letter-spacing:.2px;
  }
  label{
    color:#ffe88a; /* readable soft yellow for labels */
  }
  .hint{
    color:#c9b458;
  }
  .settings-btn{
    background:var(--accent);
    color:#000;
    box-shadow:0 2px 10px rgba(255,212,0,0.2);
  }
  .settings-btn:hover{
    filter:brightness(1.05);
  }

  /* Make the stage taller so the photo/canvas feels full-bleed on black */
  .stage{
    border-color:rgba(255,212,0,0.1);
    height:calc(100vh - 120px); /* grow stage for a fuller canvas view */
    min-height:auto;            /* override earlier min-height */
  }

  /* When collapsed, let the canvas area reclaim the full width */
  .wrap.is-collapsed{
    grid-template-columns:0px 1fr; /* panel disappears, main takes all space */
  }
  .wrap.is-collapsed main.panel{
    transform:none !important;
  }
  /* Nudge the toggle so it still feels responsive in the yellow theme */
  #panelToggle{
    background:var(--accent);
    color:#000;
    font-weight:700;
    border-right:1px solid rgba(0,0,0,0.6);
  }
  #panelToggle:hover{
    box-shadow:2px 0 10px rgba(255,212,0,0.35);
  }

  /* Inputs: subtle yellow focus ring for cohesion */
  input[type="range"]:focus,
  select:focus,
  input[type="number"]:focus,
  button:focus{
    outline:2px solid rgba(255,212,0,0.45);
    outline-offset:1px;
  }
</style>
</head>
<body>
<header>
  <div>
    <h1>The Hazmat Guys - Flaminator 9000</h1>
    <p>Train hard. Break nothing. Learn everything.</p>
  </div>
  <div style="display:flex;gap:8px;align-items:center;">
    <button class="settings-btn" id="exportGif">üéûÔ∏è Export GIF</button>
    <button class="settings-btn" id="openSettings">‚öôÔ∏è Settings</button>
  </div>
</header>

<!-- Settings Modal -->
<div id="settingsModal">
  <div class="modal-content">
    <h2>Default Settings</h2>
    <label>Intensity <input type="number" id="defIntensity" min="0" max="100" /></label>
    <label>Opacity <input type="number" id="defOpacity" min="0" max="1" step="0.01" /></label>
    <label>Size <input type="number" id="defSize" min="0.1" max="5" step="0.1" /></label>
    <label>Rise Speed <input type="number" id="defRise" min="1" max="100" /></label>
    <label>Color Temp <input type="number" id="defColorTemp" min="0" max="100" /></label>
    <label>Smoke Color <input type="number" id="defSmokeColor" min="0" max="100" /></label>
    <button id="applySettings">Apply</button>
  </div>
</div>

<div class="wrap">
  <aside class="panel">
    <fieldset>
      <legend>Base Photo</legend>
      <input type="file" id="photoInput" accept="image/*" />
      <div class="hint">Click anywhere on the canvas to move the active emitter.</div>
      <div style="display:flex;gap:6px;margin-top:6px;">
        <label style="flex:1">Active Emitter
          <select id="activeEmitter" style="width:100%">
            <option value="A">A</option>
            <option value="B">B</option>
          </select>
        </label>
        <button id="addEmitterB" style="flex:1;height:32px;font-size:14px;margin-top:20px;">‚ûï Add Emitter B</button>
      </div>
    </fieldset>

    <fieldset>
      <legend>Fire Controls</legend>
      <label>Intensity <span id="amountVal">50</span></label>
      <input type="range" id="amount" min="0" max="100" value="50" />
      <label>Opacity <span id="opacityVal">0.85</span></label>
      <input type="range" id="opacity" min="0" max="100" value="85" />
      <label>Size <span id="sizeVal">.20</span></label>
      <input type="range" id="size" min="5" max="300" value="120" />
      <label>Rise Speed <span id="riseVal">28</span></label>
      <input type="range" id="rise" min="5" max="80" value="28" />
      <label>Angle (0‚Äì360¬∞) <span id="angleVal">0</span></label>
      <input type="range" id="angle" min="0" max="360" value="0" />
      <label>Flame Length <span id="lengthVal">1.0</span>x</label>
      <input type="range" id="length" min="0.5" max="3.0" step="0.1" value="1.0" />
      <label>Flame Width <span id="widthVal">1.0</span>x</label>
      <input type="range" id="width" min="0.5" max="3.0" step="0.1" value="1.0" />
      <label>Color Temperature (Cool ‚Üí Hot) <span id="colorVal">50</span></label>
      <input type="range" id="colorTemp" min="0" max="100" value="50" />
      <label>Smoke Color (Black ‚Üí White) <span id="smokeColorVal">0</span></label>
      <input type="range" id="smokeColor" min="0" max="100" value="0" />
    </fieldset>
  </aside>

  <main class="panel">
    <div class="stage" id="stage">
      <canvas id="c" width="800" height="600"></canvas>
    </div>
  </main>
</div>

<!-- Collapsible Toggle Button -->
<button id="panelToggle" aria-label="Toggle settings panel">‚óÄ</button>

<script>
/* === ORIGINAL FIRE SIMULATION CODE (unchanged) === */
const $ = id => document.getElementById(id);
const c = $('c'), ctx = c.getContext('2d'), stage = $('stage');
let bgImg=new Image(),bgLoaded=false;
let leakA={x:400,y:550}, leakB=null;
let activeEmitter='A';

// Settings modal
const modal=$('settingsModal'),openBtn=$('openSettings'),applyBtn=$('applySettings');
if (openBtn) {
  openBtn.onclick=()=>{modal.style.display='flex';loadDefaults();};
}
applyBtn.onclick=()=>{saveDefaults();modal.style.display='none';};
window.onclick=e=>{if(e.target===modal)modal.style.display='none';};

function loadDefaults(){
  const defs=JSON.parse(localStorage.getItem('fireDefaults')||'{}');
  $('defIntensity').value=defs.intensity||50;
  $('defOpacity').value=defs.opacity||0.85;
  $('defSize').value=defs.size||.20;
  $('defRise').value=defs.rise||28;
  $('defColorTemp').value=defs.colorTemp||50;
  $('defSmokeColor').value=defs.smokeColor||0;
}
function saveDefaults(){
  const defs={
    intensity:+$('defIntensity').value,
    opacity:+$('defOpacity').value,
    size:+$('defSize').value,
    rise:+$('defRise').value,
    colorTemp:+$('defColorTemp').value,
    smokeColor:+$('defSmokeColor').value
  };
  localStorage.setItem('fireDefaults',JSON.stringify(defs));
  setStateFromDefaults(defs);
}
function setStateFromDefaults(defs){
  state.amount=defs.intensity;
  state.opacity=defs.opacity;
  state.size=defs.size;
  state.rise=defs.rise;
  state.colorTemp=defs.colorTemp;
  state.smokeColor=defs.smokeColor;
}

// Photo upload (original)
$('photoInput').addEventListener('change', e => {
  const f = e.target.files[0];
  if (!f) return;
  const url = URL.createObjectURL(f);
  bgImg.onload = () => {
    bgLoaded = true;
    c.width = bgImg.width;
    c.height = bgImg.height;
    draw();
  };
  bgImg.src = url;
});

// Emitters
$('activeEmitter').onchange = e => activeEmitter = e.target.value;
$('addEmitterB').onclick = () => { if (!leakB) leakB = {x: c.width/2 + 100, y: c.height - 50}; };

let state={amount:50,opacity:0.85,size:.20,rise:28,angle:0,length:1.0,width:1.0,colorTemp:50,smokeColor:0};

// Load defaults
(()=>{const defs=JSON.parse(localStorage.getItem('fireDefaults')||'{}');
if(Object.keys(defs).length>0){
state.amount=defs.intensity??state.amount;
state.opacity=defs.opacity??state.opacity;
state.size=defs.size??state.size;
state.rise=defs.rise??state.rise;
state.colorTemp=defs.colorTemp??state.colorTemp;
state.smokeColor=defs.smokeColor??state.smokeColor;}})();

const particles=[];
function bindSliders(){
  $('amount').oninput=()=>{state.amount=+$('amount').value;$('amountVal').textContent=state.amount.toFixed(0);};
  $('opacity').oninput=()=>{state.opacity=+$('opacity').value/100;$('opacityVal').textContent=state.opacity.toFixed(2);};
  $('size').oninput=()=>{state.size=+$('size').value/100;$('sizeVal').textContent=state.size.toFixed(2);};
  $('rise').oninput=()=>{state.rise=+$('rise').value;$('riseVal').textContent=state.rise.toFixed(0);};
  $('angle').oninput=()=>{state.angle=+$('angle').value;$('angleVal').textContent=state.angle.toFixed(0);};
  $('length').oninput=()=>{state.length=+$('length').value;$('lengthVal').textContent=state.length.toFixed(1)+'x';};
  $('width').oninput=()=>{state.width=+$('width').value;$('widthVal').textContent=state.width.toFixed(1)+'x';};
  $('colorTemp').oninput=()=>{state.colorTemp=+$('colorTemp').value;$('colorVal').textContent=state.colorTemp.toFixed(0);};
  $('smokeColor').oninput=()=>{state.smokeColor=+$('smokeColor').value;$('smokeColorVal').textContent=state.smokeColor.toFixed(0);};}
bindSliders();

const rnd=(a,b)=>a+Math.random()*(b-a);
const getColorTempRGB=t=>t<25?'255,80,40':t<50?'255,140,20':t<75?'255,200,80':'255,240,200';
function spawnEmitter(dt,e){const rate=state.amount*0.8,expect=rate*dt;let n=Math.floor(expect)+(Math.random()<(expect%1)?1:0);
const ang=state.angle*Math.PI/180;
for(let i=0;i<n;i++){const spread=rnd(-1.5,1.5)*state.size*state.width;
const lift=-rnd(1.0,2.2)*state.rise*0.04*state.length;
const vx=Math.cos(ang)*spread-Math.sin(ang)*lift*0.2;
const vy=Math.sin(ang)*spread+Math.cos(ang)*lift;
particles.push({x:e.x+rnd(-25,25),y:e.y+rnd(-5,5),vx,vy,life:rnd(1.2,2.5)*state.length,age:0,size:(state.size*100)*rnd(0.7,1.8)});}}
function spawn(dt){spawnEmitter(dt,leakA);if(leakB)spawnEmitter(dt,leakB);}
function step(dt){for(let p of particles){p.x+=p.vx*dt*60;p.y+=p.vy*dt*60;p.vx*=rnd(0.96,1.04);p.age+=dt;}
for(let i=particles.length-1;i>=0;i--)if(particles[i].age>particles[i].life)particles.splice(i,1);}
function draw(){ctx.clearRect(0,0,c.width,c.height);if(bgLoaded)ctx.drawImage(bgImg,0,0,c.width,c.height);
ctx.globalCompositeOperation='lighter';const baseColor=getColorTempRGB(state.colorTemp);
for(let p of particles){const t=p.age/p.life,a=state.opacity*(1-t),r=p.size*(0.6+t*0.8);
const grad=ctx.createRadialGradient(p.x,p.y,0,p.x,p.y,r);
grad.addColorStop(0,`rgba(${baseColor},${a})`);
grad.addColorStop(0.3,`rgba(${baseColor},${a*0.7})`);
grad.addColorStop(1,`rgba(${baseColor},0)`);
ctx.fillStyle=grad;ctx.beginPath();ctx.arc(p.x,p.y,r,0,Math.PI*2);ctx.fill();
if(t>0.6){ctx.save();ctx.globalCompositeOperation='source-over';
const smokeAlpha=(t-0.6)*1.5,shade=Math.floor(state.smokeColor*2.55);
const gradSmoke=ctx.createRadialGradient(p.x,p.y,0,p.x,p.y,r*1.8);
gradSmoke.addColorStop(0,`rgba(${shade},${shade},${shade},${smokeAlpha})`);
gradSmoke.addColorStop(1,`rgba(${shade},${shade},${shade},0)`);
ctx.fillStyle=gradSmoke;ctx.beginPath();ctx.arc(p.x,p.y,r*1.8,0,Math.PI*2);ctx.fill();ctx.restore();}}
ctx.globalCompositeOperation='source-over';}
stage.addEventListener('mousedown',e=>{const r=c.getBoundingClientRect();
const pos={x:(e.clientX-r.left)*(c.width/r.width),y:(e.clientY-r.top)*(c.height/r.height)};
if(activeEmitter==='A')leakA=pos;else if(leakB)leakB=pos;});
let last=performance.now();function tick(now){const dt=Math.min(.05,(now-last)/1000);last=now;spawn(dt);step(dt);draw();requestAnimationFrame(tick);}requestAnimationFrame(tick);

/* === Visual-only toggle append === */
(() => {
  const wrap = document.querySelector('.wrap');
  const toggle = document.getElementById('panelToggle');
  if (!wrap || !toggle) return;
  toggle.addEventListener('click', () => {
    wrap.classList.toggle('is-collapsed');
    toggle.textContent = wrap.classList.contains('is-collapsed') ? '‚ñ∂' : '‚óÄ';
  });
})();
</script>

<!-- ===== APPENDED RESIZE LOGIC FOR FULL-WIDTH CANVAS ON COLLAPSE ‚Äî APPEND ONLY ===== -->
<script>
(() => {
  const wrap = document.querySelector('.wrap');
  const toggle = document.getElementById('panelToggle');
  const stage = document.getElementById('stage');
  const c = document.getElementById('c');
  let resizeTimer;

  function resizeCanvasToStage() {
    const w = Math.max(1, stage.clientWidth);
    const h = Math.max(1, stage.clientHeight);
    if (c.width !== w || c.height !== h) {
      c.width = w;
      c.height = h;
    }
  }

  window.addEventListener('load', resizeCanvasToStage);
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(resizeCanvasToStage, 80);
  });

  if (toggle) {
    toggle.addEventListener('click', () => {
      setTimeout(() => { resizeCanvasToStage(); if (typeof window.draw==='function') window.draw(); }, 320);
    });
  }

  try{
    if (window.bgImg) {
      bgImg.addEventListener('load', () => { resizeCanvasToStage(); if (typeof window.draw==='function') window.draw(); });
    }
  }catch(e){}
})();
</script>

<!-- ===== APPENDED: Preserve photo aspect ratio (contain) ‚Äî APPEND ONLY ===== -->
<script>
(() => {
  if (window.__aspectFitPatched) return;
  window.__aspectFitPatched = true;

  function drawAspectFitBackground(ctx, img, cw, ch){
    if(!img || !img.width || !img.height) return;
    const iw = img.width, ih = img.height;
    const scale = Math.min(cw/iw, ch/ih);
    const dw = Math.max(1, Math.floor(iw * scale));
    const dh = Math.max(1, Math.floor(ih * scale));
    const dx = Math.floor((cw - dw) / 2);
    const dy = Math.floor((ch - dh) / 2);
    ctx.fillStyle = '#000';
    ctx.fillRect(0, 0, cw, ch);
    ctx.drawImage(img, dx, dy, dw, dh);
  }

  const _origDraw = window.draw;

  window.draw = function(){
    ctx.clearRect(0,0,c.width,c.height);
    if (window.bgLoaded) {
      drawAspectFitBackground(ctx, window.bgImg, c.width, c.height);
    }
    ctx.globalCompositeOperation='lighter';
    const baseColor = getColorTempRGB(state.colorTemp);
    for (let p of particles){
      const t=p.age/p.life, a=state.opacity*(1-t), r=p.size*(0.6+t*0.8);
      const grad=ctx.createRadialGradient(p.x,p.y,0,p.x,p.y,r);
      grad.addColorStop(0,`rgba(${baseColor},${a})`);
      grad.addColorStop(0.3,`rgba(${baseColor},${a*0.7})`);
      grad.addColorStop(1,`rgba(${baseColor},0)`);
      ctx.fillStyle=grad;ctx.beginPath();ctx.arc(p.x,p.y,r,0,Math.PI*2);ctx.fill();

      if (t>0.6){
        ctx.save();ctx.globalCompositeOperation='source-over';
        const smokeAlpha=(t-0.6)*1.5, shade=Math.floor(state.smokeColor*2.55);
        const gradSmoke=ctx.createRadialGradient(p.x,p.y,0,p.x,p.y,r*1.8);
        gradSmoke.addColorStop(0,`rgba(${shade},${shade},${shade},${smokeAlpha})`);
        gradSmoke.addColorStop(1,`rgba(${shade},${shade},${shade},0)`);
        ctx.fillStyle=gradSmoke;ctx.beginPath();ctx.arc(p.x,p.y,r*1.8,0,Math.PI*2);ctx.fill();ctx.restore();
      }
    }
    ctx.globalCompositeOperation='source-over';
  };

  try{
    if (window.bgImg) {
      bgImg.addEventListener('load', function(){
        const stage = document.getElementById('stage');
        const c = document.getElementById('c');
        if (stage && c){
          const w = Math.max(1, stage.clientWidth);
          const h = Math.max(1, stage.clientHeight);
          if (c.width !== w || c.height !== h){ c.width = w; c.height = h; }
        }
        if (typeof window.draw==='function') window.draw();
      });
    }
  }catch(e){}
})();
</script>

<!-- ===== APPENDED: Robust photo loader & race-condition guard ‚Äî APPEND ONLY ===== -->
<script>
(() => {
  if (window.__robustLoaderPatched) return;
  window.__robustLoaderPatched = true;

  const fileInput = document.getElementById('photoInput');
  const stage = document.getElementById('stage');
  const canvas = document.getElementById('c');
  const ctx2 = canvas.getContext('2d');

  function resizeCanvasToStageNow(){
    const w = Math.max(1, stage.clientWidth);
    const h = Math.max(1, stage.clientHeight);
    if (canvas.width !== w || canvas.height !== h) {
      canvas.width = w;
      canvas.height = h;
    }
  }

  function loadPhotoFromFile(file){
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(ev){
      const img = new Image();
      img.crossOrigin = 'anonymous';
      img.onload = function(){
        window.bgImg = img;
        window.bgLoaded = true;
        resizeCanvasToStageNow();
        ctx2.clearRect(0,0,canvas.width,canvas.height);
        if (typeof window.draw === 'function') window.draw();
      };
      img.onerror = function(){ console.warn('Image failed to load.'); };
      img.src = ev.target.result;
    };
    reader.onerror = function(){ console.warn('FileReader failed.'); };
    reader.readAsDataURL(file);
  }

  fileInput.addEventListener('change', function(e){
    const f = e.target.files && e.target.files[0];
    if (!f) return;
    loadPhotoFromFile(f);
  });

  const toggle = document.getElementById('panelToggle');
  if (toggle){
    toggle.addEventListener('click', () => setTimeout(() => {
      resizeCanvasToStageNow();
      if (typeof window.draw==='function') window.draw();
    }, 340));
  }
})();
</script>

<!-- ===== APPENDED: FIXED particle cleanup + redraw hooks ‚Äî APPEND ONLY ===== -->
<script>
(() => {
  if (window.__stepFixed) return;
  window.__stepFixed = true;

  // Save original for reference (not used, but kept in case)
  const _origStep = window.step;

  // Override step() with correct cleanup logic to prevent runtime errors
  window.step = function(dt){
    for (let p of particles){
      p.x += p.vx * dt * 60;
      p.y += p.vy * dt * 60;
      p.vx *= rnd(0.96,1.04);
      p.age += dt;
    }
    for (let i = particles.length - 1; i >= 0; i--){
      const pi = particles[i];
      if (pi.age > pi.life) particles.splice(i,1);
    }
  };

  // Also ensure a draw occurs after any window resize completes
  let __resizeTimer;
  window.addEventListener('resize', () => {
    clearTimeout(__resizeTimer);
    __resizeTimer = setTimeout(() => {
      if (typeof window.draw==='function') window.draw();
    }, 120);
  });
})();
</script>

<!-- ===== APPENDED ONLY: Match header "Settings" width to "Add Emitter B" ===== -->
<script>
(() => {
  if (window.__syncSettingsBtnWidth) return;
  window.__syncSettingsBtnWidth = true;

  const settingsBtn = document.getElementById('openSettings');
  const exportBtn = document.getElementById('exportGif');
  const addBtn = document.getElementById('addEmitterB');
  const toggle = document.getElementById('panelToggle');
  let rAF, debounce;

  function syncWidth() {
    if (!addBtn || (!settingsBtn && !exportBtn)) return;
    const rect = addBtn.getBoundingClientRect();
    const w = Math.ceil(rect.width);
    if (w > 0) {
      if (settingsBtn) settingsBtn.style.width = w + 'px';
      if (exportBtn) exportBtn.style.width = w + 'px';
    }
  }

  function scheduleSync(delay = 0) {
    clearTimeout(debounce);
    debounce = setTimeout(() => {
      cancelAnimationFrame(rAF);
      rAF = requestAnimationFrame(syncWidth);
    }, delay);
  }

  window.addEventListener('load', () => scheduleSync(0));
  window.addEventListener('resize', () => scheduleSync(50));
  if (document.fonts && document.fonts.ready) {
    document.fonts.ready.then(() => scheduleSync(0));
  }
  if (toggle) {
    toggle.addEventListener('click', () => scheduleSync(330)); // after collapse transition
  }

  // Initial attempt
  scheduleSync(0);
})();
</script>

<!-- ===== APPENDED ONLY: Unify all yellows to match the paragraph color ===== -->
<style>
  /* Use the paragraph yellow (#c9b458) for ALL yellow accents */
  :root{
    --accent: var(--muted);             /* buttons/toggles now match paragraph */
    /* RGB helper for transparent borders/shadows using same hue */
    --muted-rgb: 201,180,88;            /* #c9b458 */
  }

  /* Text colors */
  legend,
  label,
  .hint,
  .modal-content h2,
  #panelToggle { color: var(--muted) !important; }

  /* Backgrounds that were yellow ‚Üí match muted */
  .settings-btn,
  #panelToggle { background: var(--accent) !important; }

  /* Borders/underlines that used various yellows ‚Üí unify to muted with translucency */
  header,
  .panel,
  fieldset,
  .stage { border-color: rgba(var(--muted-rgb), 0.25) !important; }

  /* Focus rings & subtle outlines */
  input[type="range"]:focus,
  select:focus,
  input[type="number"]:focus,
  button:focus { outline-color: rgba(var(--muted-rgb), 0.45) !important; }

  /* Shadows unified */
  #panelToggle:hover { box-shadow: 2px 0 10px rgba(var(--muted-rgb), 0.35) !important; }
  .settings-btn { box-shadow: 0 2px 10px rgba(var(--muted-rgb), 0.20) !important; }

  legend { color: var(--muted) !important; }
  label { color: var(--muted) !important; }
  .hint { color: var(--muted) !important; }
  .modal-content h2 { color: var(--muted) !important; }
</style>

<!-- ===== APPENDED ONLY: Ensure panel toggle arrow is visible ===== -->
<style>
  /* Make the ‚óÄ / ‚ñ∂ arrow stand out against the muted-yellow background */
  #panelToggle{
    color:#000 !important;                 /* strong contrast on yellow */
    text-shadow: 0 0 2px rgba(255,255,255,0.35); /* subtle edge for readability */
  }
  #panelToggle:hover{
    color:#000 !important;                 /* keep contrast on hover */
  }
  @media (prefers-contrast: more){
    #panelToggle{ text-shadow: 0 0 3px rgba(255,255,255,0.6); }
  }
</style>

<!-- ===== APPENDED ONLY: GIF export support ===== -->
<script src="https://cdn.jsdelivr.net/npm/gif.js.optimized/dist/gif.js"></script>
<script>
(() => {
  const exportBtn = document.getElementById('exportGif');
  if (!exportBtn) return;

  function setButtonState(isBusy, label) {
    exportBtn.disabled = isBusy;
    exportBtn.textContent = label;
  }

  exportBtn.addEventListener('click', async () => {
    if (typeof GIF === 'undefined') {
      alert('GIF export library failed to load. Please check your connection and try again.');
      return;
    }

    const canvas = document.getElementById('c');
    const fps = 20;
    const durationMs = 3000;
    const frameDelay = 1000 / fps;
    const totalFrames = Math.round((durationMs / 1000) * fps);

    setButtonState(true, 'Capturing‚Ä¶');

    const gif = new GIF({
      workers: 0,
      quality: 12,
      repeat: 0,
      width: canvas.width,
      height: canvas.height
    });

    let renderTimeout;
    const startRenderTimeout = () => {
      clearTimeout(renderTimeout);
      renderTimeout = setTimeout(() => {
        gif.abort();
        alert('GIF rendering is taking too long. Please try again or reduce the canvas size.');
      }, 20000);
    };

    for (let captured = 1; captured <= totalFrames; captured += 1) {
      gif.addFrame(canvas, { copy: true, delay: frameDelay });
      setButtonState(true, `Capturing‚Ä¶ ${captured}/${totalFrames}`);
      await new Promise(resolve => setTimeout(resolve, frameDelay));
    }

    setButtonState(true, 'Rendering‚Ä¶');
    startRenderTimeout();
    gif.render();

    gif.on('progress', (p) => {
      const pct = Math.max(0, Math.min(100, Math.round(p * 100)));
      setButtonState(true, `Rendering‚Ä¶ ${pct}%`);
      startRenderTimeout();
    });

    gif.on('error', (err) => {
      clearTimeout(renderTimeout);
      console.warn(err);
      alert('GIF rendering failed. Please try again or reduce the canvas size.');
      setButtonState(false, 'üéûÔ∏è Export GIF');
    });

    gif.on('finished', (blob) => {
      clearTimeout(renderTimeout);
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'flaminator-loop.gif';
      document.body.appendChild(link);
      link.click();
      link.remove();
      URL.revokeObjectURL(url);
      setButtonState(false, 'üéûÔ∏è Export GIF');
    });

    gif.on('abort', () => {
      clearTimeout(renderTimeout);
      setButtonState(false, 'üéûÔ∏è Export GIF');
    });
  });
})();
</script>

</body>
</html>
